#!/bin/bash

:load common

function net.socket-open {
  typeset type=$1 netloc=$2 port=$3
  typeset fd

  [[ $type = @(tcp|udp) ]] || return 1
  [[ $netloc = @(*/*|..) ]] && return 1
  [[ $port = +([[:digit:]]) ]] || return 1

  exec {fd}<>"/dev/$type/$netloc/$port" || return 1

  printf %d "$fd"
}

function net.tcp-open {
  typeset netloc=$1 port=$2

  net.socket-open tcp "$netloc" "$port"
}

function net.tcp-send {
  typeset netloc=$1 port=$2
  typeset line fd
  
  fd=$(net.tcp-open "$netloc" "$port") || return 1

  while IFS= read -r line; do
    printf '%s\n' "$line";
  done > "/dev/fd/$fd"

  printf %s "$line" > "/dev/fd/$fd"

  while IFS= read -r line; do
    printf '%s\n' "$line";
  done < "/dev/fd/$fd"

  printf %s "$line"

  exec {fd}>&-
}
